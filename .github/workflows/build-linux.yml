name: Build Linux

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true

    - name: Update version from git
      run: |
        if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
          VERSION="${GITHUB_REF#refs/tags/v}"
        else
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
        fi
        BUILD_NUMBER=$(git rev-list --count HEAD)
        sed -i "s/^version: .*/version: $VERSION+$BUILD_NUMBER/" pubspec.yaml
        echo "Building version $VERSION+$BUILD_NUMBER"

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev libmpv-dev

    - name: Enable Linux desktop
      run: flutter config --enable-linux-desktop

    - name: Install dependencies
      run: flutter pub get

    - name: Build Linux Release
      run: flutter build linux --release

    - name: Bundle ONNX Runtime library
      run: |
        ONNX_VERSION="1.22.0"
        BUNDLE_LIB="build/linux/x64/release/bundle/lib"

        # Download ONNX Runtime
        wget -q "https://github.com/microsoft/onnxruntime/releases/download/v${ONNX_VERSION}/onnxruntime-linux-x64-${ONNX_VERSION}.tgz"
        tar -xzf "onnxruntime-linux-x64-${ONNX_VERSION}.tgz"

        # Copy the shared library to bundle
        cp "onnxruntime-linux-x64-${ONNX_VERSION}/lib/libonnxruntime.so.${ONNX_VERSION}" "${BUNDLE_LIB}/"

        # Create symlinks for compatibility
        cd "${BUNDLE_LIB}"
        ln -sf "libonnxruntime.so.${ONNX_VERSION}" "libonnxruntime.so.1"
        ln -sf "libonnxruntime.so.${ONNX_VERSION}" "libonnxruntime.so"

        echo "Bundled ONNX Runtime:"
        ls -la libonnxruntime*

    - name: Fix library rpaths for portability
      run: |
        sudo apt-get install -y patchelf
        cd build/linux/x64/release/bundle/lib
        for lib in *.so*; do
          if [ -f "$lib" ] && [ ! -L "$lib" ]; then
            echo "Patching rpath for $lib"
            patchelf --set-rpath '$ORIGIN' "$lib" 2>/dev/null || true
          fi
        done

    - name: Clean dangling symlinks
      run: |
        cd build/linux/x64/release/bundle/lib
        # Remove dangling symlinks (e.g., libonnxruntime.so pointing to non-existent target)
        find . -maxdepth 1 -type l ! -exec test -e {} \; -delete

    - name: Create portable archive
      run: |
        cd build/linux/x64/release
        tar -czhf ../../../../geogram-linux-x64.tar.gz bundle/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: geogram-linux-x64
        path: geogram-linux-x64.tar.gz
        retention-days: 30

    - name: Upload to Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: geogram-linux-x64.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
