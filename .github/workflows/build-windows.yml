name: Build Windows

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true

    - name: Update version from git
      shell: bash
      run: |
        if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
          VERSION="${GITHUB_REF#refs/tags/v}"
        else
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
        fi
        BUILD_NUMBER=$(git rev-list --count HEAD)
        sed -i "s/^version: .*/version: $VERSION+$BUILD_NUMBER/" pubspec.yaml
        echo "Building version $VERSION+$BUILD_NUMBER"

    - name: Enable Windows desktop
      run: flutter config --enable-windows-desktop

    - name: Install dependencies
      run: flutter pub get

    - name: Pre-download ONNX Runtime for flutter_onnxruntime
      shell: powershell
      run: |
        # The flutter_onnxruntime plugin expects ONNX Runtime at a specific path
        # Using v1.21.0 which has Windows binaries available
        $onnxVersion = "1.21.0"
        $onnxDir = "build\windows\x64\plugins\flutter_onnxruntime\onnxruntime"
        $extractDir = "$onnxDir\onnxruntime-win-x64-$onnxVersion"

        # Create the directory structure
        New-Item -ItemType Directory -Force -Path $onnxDir | Out-Null

        # Download ONNX Runtime
        $url = "https://github.com/microsoft/onnxruntime/releases/download/v$onnxVersion/onnxruntime-win-x64-$onnxVersion.zip"
        $zipPath = "$onnxDir\onnxruntime.zip"

        Write-Host "Downloading ONNX Runtime v$onnxVersion..."
        Invoke-WebRequest -Uri $url -OutFile $zipPath -UseBasicParsing

        # Extract
        Write-Host "Extracting..."
        Expand-Archive -Path $zipPath -DestinationPath $onnxDir -Force

        # Verify extraction
        if (Test-Path "$extractDir\lib\onnxruntime.dll") {
          Write-Host "ONNX Runtime extracted successfully"
          Get-ChildItem $extractDir
        } else {
          Write-Error "ONNX Runtime extraction failed"
          Get-ChildItem $onnxDir -Recurse
          exit 1
        }

        # Clean up zip file
        Remove-Item $zipPath -Force

    - name: Build Windows Release
      run: flutter build windows --release

    - name: Bundle Visual C++ Runtime
      shell: powershell
      run: |
        $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath
        Write-Host "VS Path: $vsPath"

        # Find the CRT folder - could be under v143, v142, or versioned folders
        $vcRedistPath = "$vsPath\VC\Redist\MSVC"
        Write-Host "Redist Path: $vcRedistPath"
        Write-Host "Contents:"
        Get-ChildItem $vcRedistPath

        # Look for the DLLs in all possible locations
        $dllPath = $null
        $searchPaths = @(
          "$vcRedistPath\v143\x64\Microsoft.VC143.CRT",
          "$vcRedistPath\v142\x64\Microsoft.VC142.CRT"
        )

        # Also check versioned folders (e.g., 14.38.33135)
        Get-ChildItem $vcRedistPath -Directory | ForEach-Object {
          $searchPaths += "$($_.FullName)\x64\Microsoft.VC143.CRT"
          $searchPaths += "$($_.FullName)\x64\Microsoft.VC142.CRT"
        }

        foreach ($path in $searchPaths) {
          if (Test-Path "$path\msvcp140.dll") {
            $dllPath = $path
            Write-Host "Found DLLs at: $dllPath"
            break
          }
        }

        if (-not $dllPath) {
          Write-Error "Could not find VC++ Runtime DLLs"
          exit 1
        }

        $targetPath = "build\windows\x64\runner\Release"

        Copy-Item "$dllPath\msvcp140.dll" $targetPath -Force
        Copy-Item "$dllPath\msvcp140_1.dll" $targetPath -Force
        Copy-Item "$dllPath\vcruntime140.dll" $targetPath -Force
        Copy-Item "$dllPath\vcruntime140_1.dll" $targetPath -Force

        Write-Host "Bundled VC++ Runtime DLLs to $targetPath"
        Get-ChildItem $targetPath -Filter "*.dll" | Select-Object Name

    - name: Bundle ONNX Runtime DLL
      shell: powershell
      run: |
        $targetPath = "build\windows\x64\runner\Release"

        # Check if onnxruntime.dll already exists (bundled by plugin)
        if (Test-Path "$targetPath\onnxruntime.dll") {
          Write-Host "onnxruntime.dll already bundled by plugin"
        } else {
          Write-Host "onnxruntime.dll not found, bundling explicitly..."

          # Find the downloaded ONNX Runtime DLL from the plugin build
          $onnxDll = Get-ChildItem -Path "build\windows\x64" -Recurse -Filter "onnxruntime.dll" -ErrorAction SilentlyContinue | Select-Object -First 1

          if ($onnxDll) {
            Write-Host "Found ONNX Runtime at: $($onnxDll.FullName)"
            Copy-Item $onnxDll.FullName $targetPath -Force
            Write-Host "Bundled onnxruntime.dll"
          } else {
            Write-Error "Could not find onnxruntime.dll in build directory"
            exit 1
          }
        }

        Write-Host "`nAll DLLs in release:"
        Get-ChildItem $targetPath -Filter "*.dll" | Select-Object Name, Length

    - name: Verify DLLs in release
      shell: powershell
      run: |
        $targetPath = "build\windows\x64\runner\Release"
        Write-Host "=== DLL Verification ==="
        Write-Host ""

        # List all DLLs
        Write-Host "All DLLs in release folder:"
        Get-ChildItem $targetPath -Filter "*.dll" | ForEach-Object {
          Write-Host "  $($_.Name) ($([math]::Round($_.Length / 1KB, 1)) KB)"
        }
        Write-Host ""

        # Check for critical DLLs
        $criticalDlls = @(
          "flutter_windows.dll",
          "msvcp140.dll",
          "vcruntime140.dll",
          "onnxruntime.dll"
        )

        $missing = @()
        foreach ($dll in $criticalDlls) {
          if (Test-Path "$targetPath\$dll") {
            Write-Host "[OK] $dll found"
          } else {
            Write-Host "[MISSING] $dll NOT found"
            $missing += $dll
          }
        }

        if ($missing.Count -gt 0) {
          Write-Error "Missing critical DLLs: $($missing -join ', ')"
          exit 1
        }

        Write-Host ""
        Write-Host "=== DLL verification passed ==="

    - name: Create portable archive
      run: |
        cd build/windows/x64/runner/Release
        Compress-Archive -Path * -DestinationPath ../../../../../geogram-windows-x64.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: geogram-windows-x64
        path: geogram-windows-x64.zip
        retention-days: 30

    - name: Upload to Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: geogram-windows-x64.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
