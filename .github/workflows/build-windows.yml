name: Build Windows

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.5'
        cache: true

    - name: Update version from git
      shell: bash
      run: |
        if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
          VERSION="${GITHUB_REF#refs/tags/v}"
        else
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
        fi
        BUILD_NUMBER=$(git rev-list --count HEAD)
        sed -i "s/^version: .*/version: $VERSION+$BUILD_NUMBER/" pubspec.yaml
        echo "Building version $VERSION+$BUILD_NUMBER"

    - name: Enable Windows desktop
      run: flutter config --enable-windows-desktop

    - name: Install dependencies
      run: flutter pub get

    - name: Pre-download ONNX Runtime for flutter_onnxruntime
      shell: powershell
      run: |
        # The flutter_onnxruntime plugin expects ONNX Runtime at a specific path
        # Using v1.21.0 which has Windows binaries available
        $onnxVersion = "1.21.0"
        $onnxDir = "build\windows\x64\plugins\flutter_onnxruntime\onnxruntime"
        $extractDir = "$onnxDir\onnxruntime-win-x64-$onnxVersion"

        # Create the directory structure
        New-Item -ItemType Directory -Force -Path $onnxDir | Out-Null

        # Download ONNX Runtime
        $url = "https://github.com/microsoft/onnxruntime/releases/download/v$onnxVersion/onnxruntime-win-x64-$onnxVersion.zip"
        $zipPath = "$onnxDir\onnxruntime.zip"

        Write-Host "Downloading ONNX Runtime v$onnxVersion..."
        Invoke-WebRequest -Uri $url -OutFile $zipPath -UseBasicParsing

        # Extract
        Write-Host "Extracting..."
        Expand-Archive -Path $zipPath -DestinationPath $onnxDir -Force

        # Verify extraction
        if (Test-Path "$extractDir\lib\onnxruntime.dll") {
          Write-Host "ONNX Runtime extracted successfully"
          Get-ChildItem $extractDir
        } else {
          Write-Error "ONNX Runtime extraction failed"
          Get-ChildItem $onnxDir -Recurse
          exit 1
        }

        # Clean up zip file
        Remove-Item $zipPath -Force

    - name: Build Windows Release
      run: flutter build windows --release

    - name: Bundle Visual C++ Runtime
      shell: powershell
      run: |
        $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath
        Write-Host "VS Path: $vsPath"

        $vcRedistPath = "$vsPath\VC\Redist\MSVC"
        Write-Host "Redist Path: $vcRedistPath"
        Write-Host "Full tree:"
        Get-ChildItem $vcRedistPath -Recurse -Filter "msvcp140.dll" | ForEach-Object {
          Write-Host "  $($_.FullName)  v$($_.VersionInfo.FileVersion)"
        }

        # Find all msvcp140.dll under x64 CRT folders, pick newest version
        $candidates = Get-ChildItem $vcRedistPath -Recurse -Filter "msvcp140.dll" |
          Where-Object { $_.DirectoryName -match 'x64' }

        if (-not $candidates) {
          Write-Error "Could not find any x64 msvcp140.dll under $vcRedistPath"
          exit 1
        }

        # Pick the newest by file version to match the compiler toolchain
        $best = $candidates | Sort-Object {
          [version]($_.VersionInfo.FileVersion -replace '\s.*','')
        } -Descending | Select-Object -First 1

        $dllPath = $best.DirectoryName
        Write-Host "Selected CRT folder: $dllPath"
        Write-Host "msvcp140.dll version: $($best.VersionInfo.FileVersion)"

        $targetPath = "build\windows\x64\runner\Release"

        Copy-Item "$dllPath\msvcp140.dll" $targetPath -Force
        Copy-Item "$dllPath\msvcp140_1.dll" $targetPath -Force
        Copy-Item "$dllPath\vcruntime140.dll" $targetPath -Force
        Copy-Item "$dllPath\vcruntime140_1.dll" $targetPath -Force

        $bundledVersion = (Get-Item "$targetPath\msvcp140.dll").VersionInfo.FileVersion
        Write-Host "Bundled msvcp140.dll version: $bundledVersion"

        Write-Host "Bundled VC++ Runtime DLLs to $targetPath"
        Get-ChildItem $targetPath -Filter "*.dll" | Select-Object Name

    - name: Bundle ONNX Runtime DLL
      shell: powershell
      run: |
        $targetPath = "build\windows\x64\runner\Release"

        # Check if onnxruntime.dll already exists (bundled by plugin)
        if (Test-Path "$targetPath\onnxruntime.dll") {
          Write-Host "onnxruntime.dll already bundled by plugin"
        } else {
          Write-Host "onnxruntime.dll not found, bundling explicitly..."

          # Find the downloaded ONNX Runtime DLL from the plugin build
          $onnxDll = Get-ChildItem -Path "build\windows\x64" -Recurse -Filter "onnxruntime.dll" -ErrorAction SilentlyContinue | Select-Object -First 1

          if ($onnxDll) {
            Write-Host "Found ONNX Runtime at: $($onnxDll.FullName)"
            Copy-Item $onnxDll.FullName $targetPath -Force
            Write-Host "Bundled onnxruntime.dll"
          } else {
            Write-Error "Could not find onnxruntime.dll in build directory"
            exit 1
          }
        }

        # Also bundle providers_shared if it exists
        if (-not (Test-Path "$targetPath\onnxruntime_providers_shared.dll")) {
          $providersDll = Get-ChildItem -Path "build\windows\x64" -Recurse -Filter "onnxruntime_providers_shared.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($providersDll) {
            Copy-Item $providersDll.FullName $targetPath -Force
            Write-Host "Bundled onnxruntime_providers_shared.dll"
          } else {
            Write-Host "onnxruntime_providers_shared.dll not found in build tree (may not be needed)"
          }
        } else {
          Write-Host "onnxruntime_providers_shared.dll already bundled"
        }

        Write-Host "`nAll DLLs in release:"
        Get-ChildItem $targetPath -Filter "*.dll" | Select-Object Name, Length

    - name: Verify DLLs in release
      shell: powershell
      run: |
        $targetPath = "build\windows\x64\runner\Release"
        Write-Host "=== DLL Verification ==="
        Write-Host ""

        # List all DLLs
        Write-Host "All DLLs in release folder:"
        Get-ChildItem $targetPath -Filter "*.dll" | ForEach-Object {
          Write-Host "  $($_.Name) ($([math]::Round($_.Length / 1KB, 1)) KB)"
        }
        Write-Host ""

        # Check for critical DLLs
        $criticalDlls = @(
          # Flutter core
          "flutter_windows.dll",
          # VC++ Runtime
          "msvcp140.dll", "msvcp140_1.dll", "vcruntime140.dll", "vcruntime140_1.dll",
          # Plugin DLLs
          "ble_peripheral_plugin.dll", "file_selector_windows_plugin.dll",
          "flutter_onnxruntime_plugin.dll", "flutter_webrtc_plugin.dll",
          "geolocator_windows_plugin.dll", "media_kit_libs_windows_video_plugin.dll",
          "media_kit_video_plugin.dll", "objectbox_flutter_libs_plugin.dll",
          "pdfx_plugin.dll", "permission_handler_windows_plugin.dll",
          "record_windows_plugin.dll", "screen_retriever_windows_plugin.dll",
          "share_plus_plugin.dll", "sqlite3_flutter_libs_plugin.dll",
          "url_launcher_windows_plugin.dll", "window_manager_plugin.dll",
          # Native libraries
          "onnxruntime.dll", "libwebrtc.dll", "objectbox.dll", "pdfium.dll",
          "sqlite3.dll", "libmpv-2.dll", "d3dcompiler_47.dll", "libEGL.dll",
          "libGLESv2.dll", "vk_swiftshader.dll", "vulkan-1.dll", "zlib.dll",
          # FFI plugins
          "flutter_pty.dll", "flutter_zxing.dll"
        )

        $missing = @()
        foreach ($dll in $criticalDlls) {
          if (Test-Path "$targetPath\$dll") {
            Write-Host "[OK] $dll found"
          } else {
            Write-Host "[MISSING] $dll NOT found"
            $missing += $dll
          }
        }

        if ($missing.Count -gt 0) {
          Write-Error "Missing critical DLLs: $($missing -join ', ')"
          exit 1
        }

        Write-Host ""
        Write-Host "=== DLL verification passed ==="

    - name: Analyze dependencies
      continue-on-error: true
      shell: powershell
      run: |
        $targetPath = "build\windows\x64\runner\Release"
        $exe = "$targetPath\geogram.exe"

        # Use dumpbin to list dependencies of the main exe
        Write-Host "=== geogram.exe dependencies ==="
        & dumpbin /dependents $exe 2>$null | Select-String "\.dll"

        # Check each DLL in the release folder for its dependencies
        Write-Host "`n=== Verifying all DLLs are loadable ==="
        Get-ChildItem "$targetPath\*.dll" | ForEach-Object {
          $deps = & dumpbin /dependents $_.FullName 2>$null | Select-String "\.dll"
          Write-Host "`n$($_.Name) depends on:"
          $deps | ForEach-Object { Write-Host "  $_" }
        }

    - name: Smoke-test launch
      continue-on-error: true
      shell: powershell
      run: |
        $exe = "build\windows\x64\runner\Release\geogram.exe"
        Write-Host "Attempting to launch geogram.exe..."
        $proc = Start-Process -FilePath $exe -PassThru -ErrorAction Stop
        Start-Sleep -Seconds 5
        if ($proc.HasExited) {
          Write-Error "Process exited early with code $($proc.ExitCode)"
          exit 1
        }
        Write-Host "Process running (PID: $($proc.Id)), stopping..."
        Stop-Process -Id $proc.Id -Force
        Write-Host "Smoke test passed"

    - name: Extract version for installer
      id: version
      shell: bash
      run: |
        VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"
        echo "Installer version: $VERSION"

    - name: Build installer
      shell: cmd
      run: >
        "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        /DMyAppVersion=${{ steps.version.outputs.version }}
        installer\geogram.iss

    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: geogram-windows-x64-setup
        path: build/installer/geogram-windows-x64-setup.exe
        retention-days: 30

    - name: Create portable archive
      run: |
        cd build/windows/x64/runner/Release
        Compress-Archive -Path * -DestinationPath ../../../../../geogram-windows-x64.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: geogram-windows-x64
        path: geogram-windows-x64.zip
        retention-days: 30

    - name: Upload to Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          geogram-windows-x64.zip
          build/installer/geogram-windows-x64-setup.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
