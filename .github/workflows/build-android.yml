name: Build Android

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed for git commit count

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        # Pin to 3.38.x until webf package supports Flutter 3.41+
        # (webf 0.24.12 missing WidgetsBindingObserver.handleStatusBarTap)
        flutter-version: '3.38.x'
        cache: true

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        cache-read-only: false

    - name: Clean Gradle transform caches
      run: |
        # Remove potentially corrupted transform/build caches restored from CI cache
        rm -rf ~/.gradle/caches/transforms-*
        rm -rf ~/.gradle/caches/build-cache-*
        echo "Cleaned Gradle transform caches to prevent stale cache hangs"

    - name: Setup Android signing
      env:
        ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
      run: |
        if [ -n "$ANDROID_KEYSTORE_BASE64" ]; then
          mkdir -p android/app/keystore
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/keystore/release.jks
          cat > android/key.properties << EOF
        storePassword=$ANDROID_STORE_PASSWORD
        keyPassword=$ANDROID_KEY_PASSWORD
        keyAlias=$ANDROID_KEY_ALIAS
        storeFile=keystore/release.jks
        EOF
          echo "Signing configured with release keystore"
        else
          echo "No signing secrets found, using debug signing"
        fi

    - name: Update version from git
      run: |
        # Get version from tag or pubspec
        if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
          VERSION="${GITHUB_REF#refs/tags/v}"
        else
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
        fi

        # Use git commit count as build number (always increases)
        BUILD_NUMBER=$(git rev-list --count HEAD)

        echo "Version: $VERSION, Build: $BUILD_NUMBER"

        # Update pubspec.yaml with correct version (macOS compatible)
        sed -i '' "s/^version: .*/version: $VERSION+$BUILD_NUMBER/" pubspec.yaml

        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV

    - name: Install dependencies
      run: flutter pub get

    - name: Build Android APK
      timeout-minutes: 35
      run: |
        # Use gtimeout (macOS coreutils) or timeout (Linux)
        TIMEOUT_CMD="gtimeout"
        command -v gtimeout >/dev/null 2>&1 || TIMEOUT_CMD="timeout"
        command -v $TIMEOUT_CMD >/dev/null 2>&1 || { echo "No timeout command found, installing coreutils"; brew install coreutils; TIMEOUT_CMD="gtimeout"; }

        for i in 1 2 3; do
          echo "Build attempt $i..."
          if $TIMEOUT_CMD 1500 flutter build apk --release; then
            echo "Build succeeded on attempt $i"
            exit 0
          fi
          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 124 ]; then
            echo "Build timed out on attempt $i (25 min limit)"
          else
            echo "Build failed on attempt $i (exit code $EXIT_CODE)"
          fi
          # Kill any leftover Gradle daemons before retry
          pkill -f GradleDaemon 2>/dev/null || true
          sleep 10
        done
        echo "All build attempts failed"
        exit 1

    - name: Build Android App Bundle
      timeout-minutes: 10
      run: flutter build appbundle --release

    - name: Rename APK
      run: |
        cp build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/geogram.apk

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: geogram-android-apk
        path: build/app/outputs/flutter-apk/geogram.apk
        retention-days: 30

    - name: Upload App Bundle artifact
      uses: actions/upload-artifact@v4
      with:
        name: geogram-android-aab
        path: build/app/outputs/bundle/release/app-release.aab
        retention-days: 30

    - name: Upload APK to Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: build/app/outputs/flutter-apk/geogram.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload AAB to Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: build/app/outputs/bundle/release/app-release.aab
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Set up Ruby and Fastlane for Play Store upload
    - name: Set up Ruby
      if: startsWith(github.ref, 'refs/tags/v') && env.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON != ''
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
        working-directory: fastlane
      env:
        GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}

    # Upload to Google Play Store internal track
    - name: Upload to Google Play
      if: startsWith(github.ref, 'refs/tags/v') && env.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON != ''
      env:
        GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
      run: |
        # Write the service account JSON to a file
        echo "$GOOGLE_PLAY_SERVICE_ACCOUNT_JSON" > fastlane/play-store-key.json

        # Run Fastlane to upload to internal track
        cd fastlane
        bundle exec fastlane internal

        # Clean up the key file
        rm -f play-store-key.json
