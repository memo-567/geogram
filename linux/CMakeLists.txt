# Project-level configuration.
cmake_minimum_required(VERSION 3.13)
project(runner LANGUAGES CXX)

# Override ONNX Runtime version for consistency with Windows
# Using 1.21.1 to avoid dxcore.dll dependency issue in 1.22.0+
# See: https://github.com/microsoft/onnxruntime/issues/24771
set(ONNXRUNTIME_VERSION "1.21.1" CACHE STRING "ONNX Runtime version" FORCE)

# The name of the executable created for the application. Change this to change
# the on-disk name of your application.
set(BINARY_NAME "geogram")
# The unique GTK application identifier for this application. See:
# https://wiki.gnome.org/HowDoI/ChooseApplicationID
set(APPLICATION_ID "geogram.radio")

# Explicitly opt in to modern CMake behaviors to avoid warnings with recent
# versions of CMake.
cmake_policy(SET CMP0063 NEW)

# Suppress FetchContent_Populate deprecation warning from third-party plugins
# (objectbox_flutter_libs uses the old API) - set as default for all subdirectories
set(CMAKE_POLICY_DEFAULT_CMP0169 OLD)

# Load bundled libraries from the lib/ directory relative to the binary.
set(CMAKE_INSTALL_RPATH "$ORIGIN/lib")

# Root filesystem for cross-building.
if(FLUTTER_TARGET_PLATFORM_SYSROOT)
  set(CMAKE_SYSROOT ${FLUTTER_TARGET_PLATFORM_SYSROOT})
  set(CMAKE_FIND_ROOT_PATH ${CMAKE_SYSROOT})
  set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
  set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)
  set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
  set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
endif()

# Define build configuration options.
if(NOT CMAKE_BUILD_TYPE AND NOT CMAKE_CONFIGURATION_TYPES)
  set(CMAKE_BUILD_TYPE "Debug" CACHE
    STRING "Flutter build mode" FORCE)
  set_property(CACHE CMAKE_BUILD_TYPE PROPERTY STRINGS
    "Debug" "Profile" "Release")
endif()

# Compilation settings that should be applied to most targets.
#
# Be cautious about adding new options here, as plugins use this function by
# default. In most cases, you should add new options to specific targets instead
# of modifying this function.
function(APPLY_STANDARD_SETTINGS TARGET)
  target_compile_features(${TARGET} PUBLIC cxx_std_14)
  target_compile_options(${TARGET} PRIVATE -Wall -Werror)
  target_compile_options(${TARGET} PRIVATE "$<$<NOT:$<CONFIG:Debug>>:-O3>")
  target_compile_definitions(${TARGET} PRIVATE "$<$<NOT:$<CONFIG:Debug>>:NDEBUG>")
endfunction()

# Flutter library and tool build rules.
set(FLUTTER_MANAGED_DIR "${CMAKE_CURRENT_SOURCE_DIR}/flutter")
add_subdirectory(${FLUTTER_MANAGED_DIR})

# System-level dependencies.
find_package(PkgConfig REQUIRED)
pkg_check_modules(GTK REQUIRED IMPORTED_TARGET gtk+-3.0)

# Application build; see runner/CMakeLists.txt.
add_subdirectory("runner")

# Run the Flutter tool portions of the build. This must not be removed.
add_dependencies(${BINARY_NAME} flutter_assemble)

# Only the install-generated bundle's copy of the executable will launch
# correctly, since the resources must in the right relative locations. To avoid
# people trying to run the unbundled copy, put it in a subdirectory instead of
# the default top-level location.
set_target_properties(${BINARY_NAME}
  PROPERTIES
  RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/intermediates_do_not_run"
)


# Generated plugin build rules, which manage building the plugins and adding
# them to the application.
include(flutter/generated_plugins.cmake)


# === Installation ===
# By default, "installing" just makes a relocatable bundle in the build
# directory.
set(BUILD_BUNDLE_DIR "${PROJECT_BINARY_DIR}/bundle")
if(CMAKE_INSTALL_PREFIX_INITIALIZED_TO_DEFAULT)
  set(CMAKE_INSTALL_PREFIX "${BUILD_BUNDLE_DIR}" CACHE PATH "..." FORCE)
endif()

# Start with a clean build bundle directory every time.
install(CODE "
  file(REMOVE_RECURSE \"${BUILD_BUNDLE_DIR}/\")
  " COMPONENT Runtime)

set(INSTALL_BUNDLE_DATA_DIR "${CMAKE_INSTALL_PREFIX}/data")
set(INSTALL_BUNDLE_LIB_DIR "${CMAKE_INSTALL_PREFIX}/lib")

install(TARGETS ${BINARY_NAME} RUNTIME DESTINATION "${CMAKE_INSTALL_PREFIX}"
  COMPONENT Runtime)

install(FILES "${FLUTTER_ICU_DATA_FILE}" DESTINATION "${INSTALL_BUNDLE_DATA_DIR}"
  COMPONENT Runtime)

# Install application icon
install(FILES "${CMAKE_CURRENT_SOURCE_DIR}/data/app_icon.png"
  DESTINATION "${INSTALL_BUNDLE_DATA_DIR}"
  COMPONENT Runtime)

# Install tray icon (transparent background, for system tray)
install(FILES "${CMAKE_CURRENT_SOURCE_DIR}/data/tray_icon.png"
  DESTINATION "${INSTALL_BUNDLE_DATA_DIR}"
  COMPONENT Runtime)

# Install desktop file
install(FILES "${CMAKE_CURRENT_SOURCE_DIR}/data/geogram.radio.desktop"
  DESTINATION "${INSTALL_BUNDLE_DATA_DIR}"
  COMPONENT Runtime)

# Install multi-size icons for XDG desktop integration
install(DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/icons/"
  DESTINATION "${CMAKE_INSTALL_PREFIX}/icons"
  COMPONENT Runtime)

# Install desktop integration scripts
install(PROGRAMS "${CMAKE_CURRENT_SOURCE_DIR}/scripts/install-desktop.sh"
  DESTINATION "${CMAKE_INSTALL_PREFIX}"
  COMPONENT Runtime)
install(PROGRAMS "${CMAKE_CURRENT_SOURCE_DIR}/scripts/uninstall-desktop.sh"
  DESTINATION "${CMAKE_INSTALL_PREFIX}"
  COMPONENT Runtime)

install(FILES "${FLUTTER_LIBRARY}" DESTINATION "${INSTALL_BUNDLE_LIB_DIR}"
  COMPONENT Runtime)

foreach(bundled_library ${PLUGIN_BUNDLED_LIBRARIES})
  install(FILES "${bundled_library}"
    DESTINATION "${INSTALL_BUNDLE_LIB_DIR}"
    COMPONENT Runtime)
endforeach(bundled_library)

# Bundle libopus for Opus audio encoding (used by voice messages)
# Detect architecture and select the appropriate precompiled library
if(CMAKE_SYSTEM_PROCESSOR MATCHES "aarch64|arm64")
  set(OPUS_ARCH "aarch64")
elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "armv7l|arm")
  set(OPUS_ARCH "armv7l")
elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "i686|i386|i486|i586")
  set(OPUS_ARCH "i686")
else()
  # Default to x86_64 for x86_64, amd64, and any unknown architectures
  set(OPUS_ARCH "x86_64")
endif()

set(OPUS_LIB "${CMAKE_CURRENT_SOURCE_DIR}/opus/${OPUS_ARCH}/libopus.so.0")
if(EXISTS ${OPUS_LIB})
  install(FILES "${OPUS_LIB}"
    DESTINATION "${INSTALL_BUNDLE_LIB_DIR}"
    COMPONENT Runtime)
  message(STATUS "Bundling libopus for ${OPUS_ARCH} from ${OPUS_LIB}")
else()
  message(WARNING "libopus not found for ${OPUS_ARCH} at ${OPUS_LIB}")
endif()

# Bundle TinyEMU for Console VM (lightweight x86 emulator - same as JSLinux)
# TinyEMU is statically compiled so it has no dependencies
if(CMAKE_SYSTEM_PROCESSOR MATCHES "aarch64|arm64")
  set(TINYEMU_ARCH "aarch64")
elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "x86_64|amd64")
  set(TINYEMU_ARCH "x86_64")
else()
  set(TINYEMU_ARCH "x86_64")  # Default
endif()

set(TINYEMU_BIN "${CMAKE_CURRENT_SOURCE_DIR}/tinyemu/${TINYEMU_ARCH}/temu")
if(EXISTS ${TINYEMU_BIN})
  # Install to bin/ directory
  install(PROGRAMS "${TINYEMU_BIN}"
    DESTINATION "${CMAKE_INSTALL_PREFIX}/bin"
    COMPONENT Runtime)
  message(STATUS "Bundling TinyEMU for ${TINYEMU_ARCH} from ${TINYEMU_BIN}")
else()
  message(STATUS "TinyEMU not found for ${TINYEMU_ARCH} at ${TINYEMU_BIN} - Console VM will require system QEMU")
endif()

# Bundle ONNX Runtime versioned libraries
# The flutter_onnxruntime plugin only bundles the symlink, but we need the actual versioned .so files
# Note: ONNXRUNTIME_VERSION is set at the top of this file
if(CMAKE_SYSTEM_PROCESSOR MATCHES "aarch64|arm64")
  set(ONNXRUNTIME_ARCH "aarch64")
else()
  set(ONNXRUNTIME_ARCH "x64")
endif()

set(ONNXRUNTIME_LIB_DIR "${PROJECT_BINARY_DIR}/plugins/flutter_onnxruntime/onnxruntime/onnxruntime-linux-${ONNXRUNTIME_ARCH}-${ONNXRUNTIME_VERSION}/lib")
set(ONNXRUNTIME_VERSIONED_LIB "${ONNXRUNTIME_LIB_DIR}/libonnxruntime.so.${ONNXRUNTIME_VERSION}")

if(EXISTS ${ONNXRUNTIME_VERSIONED_LIB})
  # Install the actual versioned library
  install(FILES "${ONNXRUNTIME_VERSIONED_LIB}"
    DESTINATION "${INSTALL_BUNDLE_LIB_DIR}"
    COMPONENT Runtime)
  # Create the .so.1 symlink that the runtime expects
  install(CODE "
    execute_process(COMMAND ${CMAKE_COMMAND} -E create_symlink
      libonnxruntime.so.${ONNXRUNTIME_VERSION}
      \${CMAKE_INSTALL_PREFIX}/lib/libonnxruntime.so.1)
  " COMPONENT Runtime)
  message(STATUS "Bundling ONNX Runtime ${ONNXRUNTIME_VERSION} for ${ONNXRUNTIME_ARCH}")
else()
  message(STATUS "ONNX Runtime versioned library not found at ${ONNXRUNTIME_VERSIONED_LIB}")
endif()

# Copy the native assets provided by the build.dart from all packages.
set(NATIVE_ASSETS_DIR "${PROJECT_BUILD_DIR}native_assets/linux/")
install(DIRECTORY "${NATIVE_ASSETS_DIR}"
   DESTINATION "${INSTALL_BUNDLE_LIB_DIR}"
   COMPONENT Runtime)

# Fully re-copy the assets directory on each build to avoid having stale files
# from a previous install.
set(FLUTTER_ASSET_DIR_NAME "flutter_assets")
install(CODE "
  file(REMOVE_RECURSE \"${INSTALL_BUNDLE_DATA_DIR}/${FLUTTER_ASSET_DIR_NAME}\")
  " COMPONENT Runtime)
install(DIRECTORY "${PROJECT_BUILD_DIR}/${FLUTTER_ASSET_DIR_NAME}"
  DESTINATION "${INSTALL_BUNDLE_DATA_DIR}" COMPONENT Runtime)

# Install the AOT library on non-Debug builds only.
if(NOT CMAKE_BUILD_TYPE MATCHES "Debug")
  install(FILES "${AOT_LIBRARY}" DESTINATION "${INSTALL_BUNDLE_LIB_DIR}"
    COMPONENT Runtime)
endif()
